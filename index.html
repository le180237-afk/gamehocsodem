<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT E6 Learning Hub - H·ªçc S·ªë Nh·∫≠t Ng·ªØ</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Inter v√† c√°c icon Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- FIREBASE SDK IMPORTS (MUST BE FIRST) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Thi·∫øt l·∫≠p c·∫•u h√¨nh Firebase v√† kh·ªüi t·∫°o
        // G√°n c√°c bi·∫øn to√†n c·ª•c c·∫ßn thi·∫øt cho logic JS
        window.firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.serverTimestamp = serverTimestamp;
        window.getDoc = getDoc;
        window.initializeApp = initializeApp;
        
        // B·∫≠t log Firestore
        setLogLevel('Debug');
    </script>

    <style>
        /* Thi·∫øt l·∫≠p bi·∫øn CSS cho Theme IT E6-HUST */
        :root {
            /* HUST/IT E6 Theme */
            --main-color: #BC002D; /* HUST Red */
            --accent-color: #1F2937; /* Navy Blue - Techy */
            --bg-body: #f4f7fa; /* Light Gray/Blueish */
            --bg-container: rgba(255, 255, 255, 0.98);
            --bg-option: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --score-color: #FFD700; /* Gold */
        }

        /* Dark Theme */
        .dark {
            --bg-body: #0f172a; /* Slate 900 */
            --bg-container: rgba(30, 41, 59, 0.98); /* Slate 800 */
            --bg-option: #1e293b; 
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --border-color: #334155;
            --main-color: #FCA5A5; /* Light Red */
            --accent-color: #93C5FD; /* Light Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: var(--bg-body); 
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color 0.8s, color 0.8s;
            background-image: linear-gradient(135deg, var(--bg-body) 0%, #E2E8F0 100%);
        }
        
        .dark {
            background-image: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .app-container {
            max-width: 600px;
            width: 95%;
            padding: 30px;
            background-color: var(--bg-container); 
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 15px rgba(188, 0, 45, 0.1);
            backdrop-filter: blur(8px); 
            border: 1px solid var(--border-color); 
            transition: all 0.5s;
        }

        /* HUST/IT E6 Header Style */
        .hust-jit-header {
            background-color: var(--main-color);
            color: white;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            margin: -30px -30px 20px -30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .hust-jit-logo {
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        /* Buttons */
        .btn-primary {
            background-color: var(--main-color); 
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px #990022; 
        }
        .btn-primary:hover {
            background-color: #A30027;
            transform: translateY(-1px);
            box-shadow: 0 5px #990022;
        }
        .btn-primary:active {
            transform: translateY(3px);
            box-shadow: 0 1px #990022;
        }
        
        .btn-secondary {
            background-color: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .btn-secondary:hover {
            opacity: 0.9;
        }

        /* Game Specific Styles */
        #gameArea {
            border: 2px solid var(--border-color);
        }
        .choice-button {
            background-color: #E0F2F1; 
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            transition: all 0.2s;
        }
        .choice-button:hover {
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.02);
        }
        .dark .choice-button {
            background-color: #1e293b;
            color: var(--accent-color);
        }
        .dark .choice-button:hover {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }
        
        /* NEW: Speech Glow Effect */
        .speech-glow {
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(188, 0, 45, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(188, 0, 45, 0); }
        }

        /* Replay Button */
        #replayBtn {
            font-size: 1.25rem;
            padding: 8px 15px;
            border-radius: 10px;
            background-color: var(--bg-option);
            border: 1px solid var(--border-color);
            color: var(--accent-color);
            transition: all 0.2s;
            box-shadow: 0 3px var(--border-color);
        }
        #replayBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        #replayBtn:hover:not(:disabled) {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 3px var(--accent-color);
        }
    </style>
</head>
<body class="light">

    <!-- OVERLAY v√† NAV MENU -->
    <div id="navOverlay" class="nav-overlay hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-40"></div>
    <div id="navMenu" class="nav-menu fixed top-0 left-0 w-64 h-full bg-white dark:bg-gray-900 z-50 shadow-xl transform -translate-x-full transition-transform duration-300">
        <div class="p-5">
            <h3 class="text-xl font-bold mb-5 border-b pb-3 text-main-color">L·ª∞A CH·ªåN</h3>
            <div class="space-y-2">
                <div id="navGame" class="nav-item flex items-center p-3 rounded-lg cursor-pointer bg-red-50 dark:bg-gray-800 text-main-color active" data-content="game">
                    <i class="fas fa-gamepad w-6"></i>
                    <span class="ml-3">Mini Game: Nghe & ƒêo√°n</span>
                </div>
                <div id="navConverter" class="nav-item flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-content="converter">
                    <i class="fas fa-calculator w-6"></i>
                    <span class="ml-3">C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi S·ªë</span>
                </div>
                <div id="navDateConverter" class="nav-item flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-content="date_converter">
                    <i class="fas fa-calendar-alt w-6"></i>
                    <span class="ml-3">Chuy·ªÉn ƒê·ªïi Ng√†y Th√°ng</span>
                </div>
                <div id="navScore" class="nav-item flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-content="score">
                    <i class="fas fa-trophy w-6"></i>
                    <span class="ml-3">C·∫•p B·∫≠c & ƒêi·ªÉm</span>
                </div>
            </div>

            <div class="absolute bottom-5 w-5/6">
                 <button id="themeToggle" class="w-full btn-secondary text-sm bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors shadow-none">
                    <i class="fas fa-moon mr-2" id="themeIcon"></i>
                    <span id="themeText">Ch·ªß ƒë·ªÅ T·ªëi</span>
                </button>
                <button id="authBtn" class="w-full mt-3 text-sm btn-primary bg-main-color hover:bg-red-700" disabled>
                    <i class="fas fa-sign-in-alt mr-2"></i> ƒêang t·∫£i...
                </button>
                <div class="mt-2 text-xs text-center text-gray-500 dark:text-gray-400 truncate" id="userIdDisplay"></div>
            </div>
        </div>
    </div>
    
    <!-- N·ªôi dung ch√≠nh c·ªßa ·ª©ng d·ª•ng -->
    <div class="app-container">
        
        <!-- HEADER IT E6-HUST -->
        <div class="hust-jit-header flex justify-between items-center">
            <button id="openMenuBtn" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition text-white">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="text-center">
                <h1 class="hust-jit-logo">IT E6-HUST</h1>
                <p class="text-xs font-light opacity-80">IT E6 - Japanese IT Program</p>
            </div>
            <div id="miniScoreDisplay" class="text-right">
                <p class="text-xs font-light opacity-80">ƒêi·ªÉm</p>
                <!-- S·ª¨A L·ªñI HI·ªÇN TH·ªä ƒêI·ªÇM -->
                <p class="text-xl font-bold text-score-color" id="currentScore">0</p>
            </div>
        </div>

        <!-- KHU V·ª∞C N·ªòI DUNG CHUY·ªÇN ƒê·ªîI -->
        <div id="contentArea" class="space-y-6">
            
            <!-- 1. MINI GAME: GUESS THE NUMBER (M·∫∑c ƒë·ªãnh) -->
            <div id="gameContent" data-page="game" class="page-content">
                <h2 class="text-xl font-bold mb-4 flex items-center text-gray-800 dark:text-white">
                    <i class="fas fa-headset text-main-color mr-3"></i> MINI GAME: Nghe & ƒêo√°n S·ªë
                </h2>
                
                <div id="scoreBoard" class="flex justify-between items-center p-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 mb-4">
                    <div class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                        <i class="fas fa-coins text-yellow-500 mr-2"></i>
                        <span>T·ªïng ƒêi·ªÉm:</span> <span class="text-lg font-bold text-main-color ml-2" id="gameTotalScore">0</span>
                    </div>
                    <div class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                        <i class="fas fa-fire text-red-600 mr-2"></i>
                        <span>COMBO:</span> <span class="text-lg font-bold text-red-600 ml-2" id="gameComboStreak">0</span>
                    </div>
                </div>
                
                <!-- Khu v·ª±c ƒëi·ªÅu ch·ªânh ph·∫°m vi -->
                <p class="text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Ch·ªçn Ph·∫°m Vi S·ªë:</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                    <button class="range-button p-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 transition" data-range="99">0 - 99</button>
                    <button class="range-button p-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 transition active" data-range="999">0 - 999</button>
                    <button class="range-button p-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 transition" data-range="9999">0 - 9,999</button>
                    <button class="range-button p-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 transition" data-range="999999">0 - 999,999</button>
                </div>


                <div id="gameArea" class="p-5 rounded-xl mb-4 bg-gray-50 dark:bg-gray-800">
                    <p class="text-md mb-3 text-gray-700 dark:text-gray-300 text-center" id="rangeDisplay">Ph·∫°m vi hi·ªán t·∫°i: 0 - 999.</p>
                    
                    <div class="flex justify-center items-center space-x-4 mb-6">
                        <button id="startGameBtn" class="btn-primary flex items-center gap-2" title="Ph√°t √Çm S·ªë">
                            <i class="fas fa-volume-up"></i> Ph√°t √Çm S·ªë
                        </button>
                        <button id="replayBtn" title="Nghe l·∫°i (Gi·ªõi h·∫°n theo c·∫•p b·∫≠c)" disabled>
                            <i class="fas fa-redo"></i> 
                            <span id="replaysLeftDisplay" class="ml-1 text-sm font-semibold">2</span>
                        </button>
                    </div>

                    <div id="gameChoices" class="grid grid-cols-2 gap-4 w-full opacity-0 pointer-events-none transition-opacity duration-500">
                        <!-- C√°c n√∫t l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                    </div>
                    <p id="gameMessage" class="mt-4 font-semibold italic min-h-[20px] text-lg text-center text-accent-color"></p>
                </div>

                <p class="text-xs text-gray-500 dark:text-gray-400 text-center">L∆∞u √Ω: L∆∞·ª£t nghe l·∫°i gi·ªõi h·∫°n ƒë·ªÉ luy·ªán kh·∫£ nƒÉng nghe t·∫≠p trung.</p>
            </div>
            
            <!-- 2. C√îNG C·ª§ CHUY·ªÇN ƒê·ªîI S·ªê -->
            <div id="converterContent" data-page="converter" class="page-content hidden">
                 <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-white">
                    <i class="fas fa-calculator text-main-color mr-3"></i> C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi S·ªë ƒê·∫øm
                </h2>
                <input type="number" id="inputNumber" placeholder="V√≠ d·ª•: 10000, 350000, 9999999" 
                   class="input-field w-full text-xl text-center tracking-wide mb-4 border-2 p-3 rounded-lg" 
                   min="0" max="9999999">
                   
                <button id="convertButton" class="btn-primary w-full flex items-center justify-center gap-2 mb-6">
                    <i class="fas fa-exchange-alt"></i> Chuy·ªÉn ƒê·ªïi
                </button>
                
                <div id="resultBox" class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 hidden transition-all">
                    <!-- Output content here -->
                </div>
            </div>
            
            <!-- 3. CHUY·ªÇN ƒê·ªîI NG√ÄY TH√ÅNG -->
            <div id="dateConverterContent" data-page="date_converter" class="page-content hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-white">
                    <i class="fas fa-calendar-alt text-main-color mr-3"></i> Chuy·ªÉn ƒê·ªïi Ng√†y Th√°ng
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ch·ªçn ng√†y th√°ng ƒë·ªÉ xem c√°ch ƒë·ªçc ti·∫øng Nh·∫≠t:</p>
                
                <input type="date" id="inputDate" class="input-field w-full text-lg mb-4 border-2 p-3 rounded-lg">
                   
                <button id="convertDateButton" class="btn-primary w-full flex items-center justify-center gap-2 mb-6">
                    <i class="fas fa-language"></i> Chuy·ªÉn ƒê·ªïi Ng√†y
                </button>
                
                <div id="dateResultBox" class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 hidden transition-all">
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-400 mb-2">C√°ch ƒë·ªçc ti·∫øng Nh·∫≠t (Hiragana/Romaji):</p>
                    <div id="dateConverterOutput" class="font-bold"></div>
                    <button id="copyDateOutputButton" class="mt-2 text-xs text-gray-500 dark:text-gray-400 hover:text-main-color transition">
                        <i class="fas fa-copy mr-1"></i> Copy K·∫øt Qu·∫£
                    </button>
                </div>
            </div>
            
            <!-- 4. C·∫§P B·∫¨C V√Ä ƒêI·ªÇM -->
             <div id="scoreContent" data-page="score" class="page-content hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800 dark:text-white">
                    <i class="fas fa-trophy text-main-color mr-3"></i> C·∫•p B·∫≠c H·ªçc Gi·∫£ Nh·∫≠t Ng·ªØ
                </h2>
                
                <div class="bg-red-50 dark:bg-red-900 p-6 rounded-xl border-2 border-red-300 dark:border-red-700 text-center space-y-3">
                    <p class="text-sm text-gray-600 dark:text-gray-300">B·∫°n ƒë√£ t√≠ch l≈©y:</p>
                    <!-- S·ª¨A L·ªñI HI·ªÇN TH·ªä ƒêI·ªÇM -->
                    <p class="text-5xl font-extrabold text-main-color dark:text-yellow-400" id="totalScoreDisplay">0</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-white">ƒêi·ªÉm Th∆∞·ªüng</p>
                </div>

                <div class="mt-6 p-4 border rounded-xl border-gray-200 dark:border-gray-700 space-y-4">
                    <p class="font-bold text-lg flex items-center text-main-color dark:text-main-color">
                        <i class="fas fa-star mr-2"></i> C·∫•p B·∫≠c Hi·ªán T·∫°i:
                    </p>
                    <div class="flex justify-between items-center text-lg font-medium">
                        <span id="badgeName" class="text-2xl font-black text-accent-color dark:text-accent-color">H·ªçc Vi√™n</span>
                        <span id="badgeProgress" class="text-gray-500 dark:text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                        <div id="badgeProgressBar" class="bg-main-color h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                     <p class="text-sm text-gray-600 dark:text-gray-400">ƒêi·ªÉm c·∫ßn ƒë·∫°t ƒë·ªÉ l√™n c·∫•p ti·∫øp theo: <span id="nextLevelScore">100</span></p>
                </div>
            </div>
            
        </div>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-main-color text-white p-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50"></div>

        <!-- FOOTER -->
        <div class="text-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400">
            <p>IT E6 - HUST | Ph√°t tri·ªÉn b·ªüi L·ª£i L√™</p>
        </div>
        
    </div>

    <!-- M√É JAVASCRIPT -->
    <script type="module">
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);

        // --- GLOBAL STATE & FIREBASE CACHE ---
        const gameState = {
            userId: 'anon',
            totalScore: 0,
            comboStreak: 0,
            replaysLeftInRound: 0, 
            maxReplaysAllowed: 2,  
            currentGameNumber: null,
            maxNumber: 999,
            minNumber: 0,
            isAuthReady: false,
        };
        
        // C·∫ßn ƒë∆∞·ª£c g√°n t·ª´ window sau khi import module firebase
        let db, auth, scoreRef; 
        
        const BADGE_LEVELS = [
            { name: "H·ªçc Vi√™n", score: 0, icon: "üë∂", maxReplays: 2 },
            { name: "S∆° C·∫•p (N5)", score: 100, icon: "‚≠ê", maxReplays: 1 },
            { name: "Trung C·∫•p (N4)", score: 500, icon: "üí°", maxReplays: 0 },
            { name: "Th√†nh Th·∫°o (N3)", score: 1500, icon: "üî•", maxReplays: 0 },
            { name: "Cao C·∫•p (N2)", score: 5000, icon: "üèÜ", maxReplays: 0 },
            { name: "Chuy√™n Gia (N1)", score: 10000, icon: "üèÖ", maxReplays: 0 },
            { name: "H·ªçc Gi·∫£", score: 30000, icon: "üéì", maxReplays: 0 },
        ];
        
        // --- DOM ELEMENTS ---
        const currentScoreEl = $('#currentScore');
        const gameTotalScoreEl = $('#gameTotalScore');
        const gameComboStreakEl = $('#gameComboStreak');
        const startGameBtn = $('#startGameBtn');
        const replayBtn = $('#replayBtn'); 
        const replaysLeftDisplay = $('#replaysLeftDisplay'); 
        const gameChoicesEl = $('#gameChoices');
        const gameMessageEl = $('#gameMessage');
        const rangeDisplayEl = $('#rangeDisplay');
        const totalScoreDisplayEl = $('#totalScoreDisplay');
        const badgeNameEl = $('#badgeName');
        const badgeProgressBarEl = $('#badgeProgressBar');
        const badgeProgressEl = $('#badgeProgress');
        const nextLevelScoreEl = $('#nextLevelScore');
        const toastEl = $('#toast');
        const navItems = $$('.nav-item');
        const rangeButtons = $$('.range-button');
        const authBtn = $('#authBtn');
        const userIdDisplay = $('#userIdDisplay');
        
        let voices = [];
        let ttsActive = false;
        let currentHiragana = ''; // L∆∞u hiragana ƒë·ªÉ replay

        // --- FIREBASE & AUTH LOGIC ---
        async function setupFirebase() {
            if (!window.firebaseConfig) {
                console.error("Firebase config not available. Running in local mode.");
                gameState.isAuthReady = true;
                authBtn.textContent = 'L·ªói Config';
                return;
            }
            
            const app = window.initializeApp(window.firebaseConfig);
            auth = window.getAuth(app);
            db = window.getFirestore(app);
            
            authBtn.textContent = 'ƒêang x√°c th·ª±c...';
            
            // 1. Authenticate
            try {
                if (window.initialAuthToken) {
                    await window.signInWithCustomToken(auth, window.initialAuthToken);
                } else {
                    await window.signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                // Fallback to anonymous if custom token fails
                await window.signInAnonymously(auth);
            }

            // 2. Auth State Listener
            window.onAuthStateChanged(auth, (user) => {
                if (user) {
                    gameState.userId = user.uid;
                    gameState.isAuthReady = true;
                    console.log("User signed in:", gameState.userId);
                    
                    userIdDisplay.textContent = `ID: ${gameState.userId}`;
                    authBtn.textContent = 'ƒêƒÉng Xu·∫•t';
                    authBtn.onclick = handleSignOut;
                    authBtn.disabled = false;
                    
                    loadUserData(gameState.userId);
                } else {
                    gameState.userId = 'anon';
                    gameState.isAuthReady = true;
                    gameState.totalScore = 0; // Reset score if signed out
                    
                    userIdDisplay.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
                    authBtn.textContent = 'ƒêƒÉng Nh·∫≠p';
                    authBtn.onclick = handleSignIn; // In this environment, reload page for new token
                    authBtn.disabled = true; // Cannot sign in/out manually, only on token refresh
                }
            });
        }
        
        function handleSignOut() {
            // In Canvas environment, we rely on the token/session refresh, but we keep the illusion of sign out
            window.signOut(auth).then(() => {
                showToast("ƒê√£ ƒëƒÉng xu·∫•t (K·∫øt qu·∫£ s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u).", 'error');
                updateScoreDisplay(); // Reset UI scores
            }).catch(error => {
                console.error("Sign Out Error:", error);
                showToast("L·ªói ƒëƒÉng xu·∫•t.", 'error');
            });
        }

        function handleSignIn() {
             showToast("Vui l√≤ng ƒë·ª£i m√¥i tr∆∞·ªùng Canvas refresh token.", 'accent-color');
        }

        // --- FIRESTORE LOGIC ---
        function getScoreDocRef(userId) {
             const appId = window.appId;
             // Private data path: /artifacts/{appId}/users/{userId}/japanese_scores/data
             return window.doc(db, `artifacts/${appId}/users/${userId}/japanese_scores`, 'data');
        }

        function loadUserData(userId) {
            if (!db) return;
            
            // Set up real-time listener
            scoreRef = getScoreDocRef(userId);

            window.onSnapshot(scoreRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.totalScore = data.totalScore || 0;
                    gameState.comboStreak = data.comboStreak || 0;
                    console.log("Data loaded from Firestore:", data);
                } else {
                    // Create initial document
                    saveUserData();
                    console.log("No data found, initializing new record.");
                }
                updateScoreDisplay(); // Update UI with loaded/initial data
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showToast("L·ªói t·∫£i d·ªØ li·ªáu t·ª´ Firestore.", 'error');
            });
        }
        
        async function saveUserData() {
            if (!db || gameState.userId === 'anon') return;

            try {
                await window.setDoc(getScoreDocRef(gameState.userId), {
                    userId: gameState.userId,
                    totalScore: gameState.totalScore,
                    comboStreak: gameState.comboStreak,
                    lastUpdated: window.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Firestore Save Error:", error);
                showToast("L·ªói l∆∞u d·ªØ li·ªáu.", 'error');
            }
        }
        
        // --- UTILS & CORE LOGIC ---
        
        // Simplified mapping (used for core numbers)
        const numberMap = {
            0: 'rei', 1: 'ichi', 2: 'ni', 3: 'san', 4: 'yon', 
            5: 'go', 6: 'roku', 7: 'nana', 8: 'hachi', 9: 'kyuu',
            10: 'juu'
        };

        const hiraganaMap = {
            'a': '„ÅÇ', 'i': '„ÅÑ', 'u': '„ÅÜ', 'e': '„Åà', 'o': '„Åä',
            'ka': '„Åã', 'ki': '„Åç', 'ku': '„Åè', 'ke': '„Åë', 'ko': '„Åì',
            'sa': '„Åï', 'shi': '„Åó', 'su': '„Åô', 'se': '„Åõ', 'so': '„Åù',
            'ta': '„Åü', 'chi': '„Å°', 'tsu': '„Å§', 'te': '„Å¶', 'to': '„Å®',
            'na': '„Å™', 'ni': '„Å´', 'nu': '„Å¨', 'ne': '„Å≠', 'no': '„ÅÆ',
            'ha': '„ÅØ', 'hi': '„Å≤', 'fu': '„Åµ', 'he': '„Å∏', 'ho': '„Åª',
            'ma': '„Åæ', 'mi': '„Åø', 'mu': '„ÇÄ', 'me': '„ÇÅ', 'mo': '„ÇÇ',
            'ya': '„ÇÑ', 'yu': '„ÇÜ', 'yo': '„Çà', 
            'ra': '„Çâ', 'ri': '„Çä', 'ru': '„Çã', 're': '„Çå', 'ro': '„Çç',
            'wa': '„Çè', 'wo': '„Çí', 'n': '„Çì', 
            // Glottalized sounds
            'ga': '„Åå', 'gi': '„Åé', 'gu': '„Åê', 'ge': '„Åí', 'go': '„Åî',
            'za': '„Åñ', 'ji': '„Åò', 'zu': '„Åö', 'ze': '„Åú', 'zo': '„Åû',
            'da': '„Å†', 'de': '„Åß', 'do': '„Å©', 
            'ba': '„Å∞', 'bi': '„Å≥', 'bu': '„Å∂', 'be': '„Åπ', 'bo': '„Åº',
            'pa': '„Å±', 'pi': '„Å¥', 'pu': '„Å∑', 'pe': '„Å∫', 'po': '„ÅΩ',
            // Small Y-sounds
            'kya': '„Åç„ÇÉ', 'kyu': '„Åç„ÇÖ', 'kyo': '„Åç„Çá',
            'sha': '„Åó„ÇÉ', 'shu': '„Åó„ÇÖ', 'sho': '„Åó„Çá',
            'cha': '„Å°„ÇÉ', 'chu': '„Å°„ÇÖ', 'cho': '„Å°„Çá',
            'nya': '„Å´„ÇÉ', 'nyu': '„Å´„ÇÖ', 'nyo': '„Å´„Çá',
            'hya': '„Å≤„ÇÉ', 'hyu': '„Å≤„ÇÖ', 'hyo': '„Å≤„Çá',
            'mya': '„Åø„ÇÉ', 'myu': '„Åø„ÇÖ', 'myo': '„Åø„Çá',
            'rya': '„Çä„ÇÉ', 'ryu': '„Çä„ÇÖ', 'ryo': '„Çä„Çá',
            'gya': '„Åé„ÇÉ', 'gyu': '„Åé„ÇÖ', 'gyo': '„Åé„Çá',
            'ja': '„Åò„ÇÉ', 'ju': '„Åò„ÇÖ', 'jo': '„Åò„Çá',
            'bya': '„Å≥„ÇÉ', 'byu': '„Å≥„ÇÖ', 'byo': '„Å≥„ÇÖ',
            'pya': '„Å¥„ÇÉ', 'pyu': '„Å¥„ÇÖ', 'pyo': '„Å¥„Çá',
            // Small tsu and special
            'xtsu': '„Å£', // placeholder for small tsu logic
            'tto': '„Å£„Å®',
            'kke': '„Å£„Åë',
            // Long vowels (handled by parsing logic)
            'ou': '„Åä„ÅÜ',
            'ee': '„Åà„ÅÑ', // Default long e
            'ei': '„Åà„ÅÑ',
        };


        function convertToRomaji(num) { 
            if (num < 0 || num > 9999999) return "L·ªói: S·ªë kh√¥ng h·ª£p l·ªá.";
            if (num === 0) return 'zero';

            let romaji = '';
            let tempNum = num;

            // H√†ng Tri·ªáu (Hyakuman)
            if (tempNum >= 1000000) {
                const hyakumanPart = Math.floor(tempNum / 1000000);
                tempNum %= 1000000;
                romaji += convertLessThan10000(hyakumanPart) + 'hyakuman'; 
                if (tempNum > 0) romaji += ' ';
            }
            
            // H√†ng Ch·ª•c Tri·ªáu (Man)
            if (tempNum >= 10000) {
                const manPart = Math.floor(tempNum / 10000);
                tempNum %= 10000;
                
                romaji += convertLessThan10000(manPart).replace('ichi', '') + 'man'; // man doesn't use ichi
                if (tempNum > 0) romaji += ' ';
            }

            if (tempNum > 0) {
                romaji += convertLessThan10000(tempNum);
            }

            return romaji.trim();
        }

        function convertLessThan10000(n) { 
            let s = '';
            let num = n;

            // H√†ng ng√†n (Sen)
            if (num >= 1000) {
                const sen = Math.floor(num / 1000);
                num %= 1000;
                
                if (s.length > 0) s += ' ';

                if (sen === 1) s += 'sen';
                else if (sen === 3) s += 'sanzen'; 
                else if (sen === 8) s += 'hassen';
                else s += convertLessThan100(sen) + 'sen';
            }

            // H√†ng trƒÉm (Hyaku)
            if (num >= 100) {
                const hyaku = Math.floor(num / 100);
                num %= 100;

                if (s.length > 0) s += ' ';
                
                if (hyaku === 1) s += 'hyaku';
                else if (hyaku === 3) s += 'sanbyaku';
                else if (hyaku === 6) s += 'roppyaku';
                else if (hyaku === 8) s += 'happyaku';
                else s += convertLessThan100(hyaku) + 'hyaku';
            }

            // H√†ng ch·ª•c & ƒê∆°n v·ªã
            if (num > 0) {
                if (s.length > 0) s += ' ';
                s += convertLessThan100(num);
            }
            
            return s.trim();
        }
        
        function convertLessThan100(num) {
            if (num === 0) return '';
            if (num <= 10) return numberMap[num];
            if (num < 20) return 'juu' + numberMap[num % 10]; // 11-19
            
            const juu = Math.floor(num / 10);
            const ichi = num % 10;
            
            let s = numberMap[juu] + 'juu';
            if (ichi > 0) s += ' ' + numberMap[ichi];
            
            return s;
        }

        function romajiToHiragana(romaji) { 
            let hiragana = '';
            let i = 0;
            let cleanRomaji = romaji.toLowerCase().replace(/\s/g, ''); 
            
            // X·ª≠ l√Ω √¢m ƒë√¥i ('tsu' nh·ªè)
            cleanRomaji = cleanRomaji.replace(/([ksthpztdbg])\1/g, (match, p1) => {
                 return '„Å£' + p1;
            });
            
            // Fix special sounds (chi, tsu)
            cleanRomaji = cleanRomaji.replace('cch', 'tch');
            cleanRomaji = cleanRomaji.replace('ss', 'susu'); // Simplified for TTS clarity
            
            const keys = Object.keys(hiraganaMap).sort((a, b) => b.length - a.length);

            while (i < cleanRomaji.length) {
                let matched = false;
                
                for (const key of keys) {
                    if (cleanRomaji.substring(i, i + key.length) === key) {
                        hiragana += hiraganaMap[key];
                        i += key.length;
                        matched = true;
                        break;
                    }
                }
                
                if (!matched) {
                    hiragana += cleanRomaji[i];
                    i++;
                }
            }
            
            // Long vowel fix (romajiToHiragana only covers basic mapping, TTS handles final pronunciation)
            // 'ou' is generally pronounced as long 'o' („Åä„ÅÜ -> „Åä„Åä in common speech)
            hiragana = hiragana.replace(/„Åä„ÅÜ/g, '„Åä„Åä'); 
            
            return hiragana;
        }

        // --- SPEECH UTILS (TTS) ---
        function populateVoiceList() {
            // L·∫•y t·∫•t c·∫£ gi·ªçng n√≥i c√≥ s·∫µn v√† l·ªçc ra gi·ªçng Nh·∫≠t (ja-JP)
            voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('ja'));
        }
        
        let voiceCheckInterval = null; 
        function startVoiceCheck() {
             populateVoiceList();
             if (voices.length === 0) {
                 voiceCheckInterval = setInterval(populateVoiceList, 200);
             } else if (voiceCheckInterval) {
                 clearInterval(voiceCheckInterval);
             }
        }

        function speakText(text) {
            if (!text || voices.length === 0) {
                 showToast("Kh√¥ng t√¨m th·∫•y gi·ªçng Nh·∫≠t tr√™n thi·∫øt b·ªã c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t TTS c·ªßa h·ªá ƒëi·ªÅu h√†nh.", 'error');
                 startGameBtn.textContent = 'Ph√°t √Çm S·ªë';
                 startGameBtn.disabled = false;
                 return;
            }
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            // ∆Øu ti√™n gi·ªçng m·∫∑c ƒë·ªãnh ti·∫øng Nh·∫≠t, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y gi·ªçng ƒë·∫ßu ti√™n
            utterance.voice = voices.find(v => v.default) || voices[0]; 
            utterance.lang = 'ja-JP';
            utterance.rate = 1.0; // ƒê√£ ch·ªânh l·∫°i t·ªëc ƒë·ªô v·ªÅ 1.0 (ti√™u chu·∫©n) ƒë·ªÉ √¢m thanh r√µ h∆°n
            utterance.pitch = 1.0;
            
            const targetButton = gameChoicesEl.classList.contains('opacity-0') ? startGameBtn : replayBtn;

            utterance.onstart = () => {
                targetButton.classList.add('speech-glow');
                ttsActive = true;
                startGameBtn.disabled = true;
                replayBtn.disabled = true;
            };
            utterance.onend = () => {
                targetButton.classList.remove('speech-glow');
                ttsActive = false;
                
                startGameBtn.disabled = false;
                updateReplayButtonState(); // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i n√∫t replay
                
                if(gameChoicesEl.classList.contains('opacity-0')) {
                     gameChoicesEl.classList.remove('opacity-0', 'pointer-events-none');
                     showToast("Ch·ªçn ƒë√°p √°n ngay!", 'main-color');
                } else {
                     showToast("Nghe l·∫°i ho√†n t·∫•t.", 'accent-color');
                }
            };
            utterance.onerror = (e) => {
                 showToast(`L·ªói ph√°t √¢m: ${e.error}`, 'error');
                 targetButton.classList.remove('speech-glow');
                 ttsActive = false;
                 startGameBtn.disabled = false;
                 updateReplayButtonState();
                 gameChoicesEl.classList.remove('opacity-0', 'pointer-events-none');
            }

            speechSynthesis.speak(utterance);
        }
        
        // --- GAME & UI LOGIC ---

        function updateReplayAllowance() {
            const score = gameState.totalScore;
            let maxReplays = 0;
            
            for (let i = BADGE_LEVELS.length - 1; i >= 0; i--) {
                if (score >= BADGE_LEVELS[i].score) {
                    maxReplays = BADGE_LEVELS[i].maxReplays;
                    break;
                }
            }
            gameState.maxReplaysAllowed = maxReplays;
        }

        function updateReplayButtonState() {
            replayBtn.disabled = gameState.replaysLeftInRound <= 0 || ttsActive || gameState.currentGameNumber === null;
            replaysLeftDisplay.textContent = `${gameState.replaysLeftInRound}/${gameState.maxReplaysAllowed}`;
            
            if (gameState.maxReplaysAllowed === 0) {
                 replayBtn.title = 'Kh√¥ng ƒë∆∞·ª£c nghe l·∫°i ·ªü c·∫•p ƒë·ªô n√†y';
                 replaysLeftDisplay.textContent = '0';
                 replayBtn.disabled = true;
            } else {
                 replayBtn.title = `Nghe l·∫°i (${gameState.replaysLeftInRound} l∆∞·ª£t c√≤n l·∫°i)`;
            }
        }

        function updateScoreDisplay() {
            updateReplayAllowance(); // C·∫≠p nh·∫≠t gi·ªõi h·∫°n nghe l·∫°i
            
            // S·ª¨A L·ªñI HI·ªÇN TH·ªä ƒêI·ªÇM: Th√™m toLocaleString ƒë·ªÉ ƒë·ªãnh d·∫°ng s·ªë l·ªõn
            currentScoreEl.textContent = gameState.totalScore.toLocaleString('vi-VN');
            gameTotalScoreEl.textContent = gameState.totalScore.toLocaleString('vi-VN');
            gameComboStreakEl.textContent = gameState.comboStreak;
            totalScoreDisplayEl.textContent = gameState.totalScore.toLocaleString('vi-VN');
            
            // C·∫≠p nh·∫≠t Badge
            let currentBadge = BADGE_LEVELS[0];
            let nextBadge = null;
            
            for (let i = 0; i < BADGE_LEVELS.length; i++) {
                if (gameState.totalScore >= BADGE_LEVELS[i].score) {
                    currentBadge = BADGE_LEVELS[i];
                    nextBadge = BADGE_LEVELS[i + 1] || null;
                }
            }

            badgeNameEl.innerHTML = `${currentBadge.icon} ${currentBadge.name}`;
            
            if (nextBadge) {
                const requiredScore = nextBadge.score;
                const prevScore = currentBadge.score;
                const scoreDiff = requiredScore - prevScore;
                const currentProgress = gameState.totalScore - prevScore;
                const progressPercentage = Math.min(100, Math.floor((currentProgress / scoreDiff) * 100));

                nextLevelScoreEl.textContent = requiredScore.toLocaleString('vi-VN');
                badgeProgressBarEl.style.width = `${progressPercentage}%`;
                badgeProgressEl.textContent = `${progressPercentage}%`;
            } else {
                nextLevelScoreEl.textContent = "ƒê√£ ƒë·∫°t c·∫•p cao nh·∫•t!";
                badgeProgressBarEl.style.width = '100%';
                badgeProgressEl.textContent = 'MAX';
            }
            
            if (gameState.isAuthReady) {
                 saveUserData(); // L∆∞u d·ªØ li·ªáu sau khi c·∫≠p nh·∫≠t
            }
        }
        
        function generateGameRound() {
            // 1. Reset tr·∫°ng th√°i v√≤ng ch∆°i
            gameChoicesEl.innerHTML = '';
            gameMessageEl.textContent = 'Nghe v√† ch·ªçn s·ªë ƒë√∫ng:';
            gameChoicesEl.classList.add('opacity-0', 'pointer-events-none');
            
            // Reset l∆∞·ª£t nghe l·∫°i d·ª±a tr√™n c·∫•p b·∫≠c hi·ªán t·∫°i
            updateReplayAllowance(); 
            gameState.replaysLeftInRound = gameState.maxReplaysAllowed;
            updateReplayButtonState();

            // 2. Ch·ªçn s·ªë ng·∫´u nhi√™n
            const max = gameState.maxNumber;
            const min = gameState.minNumber;
            const correctNumber = Math.floor(Math.random() * (max + 1 - min)) + min;
            gameState.currentGameNumber = correctNumber;

            // 3. Chuy·ªÉn ƒë·ªïi th√†nh Hiragana ƒë·ªÉ ƒë·ªçc v√† l∆∞u l·∫°i
            const romaji = convertToRomaji(correctNumber);
            currentHiragana = romajiToHiragana(romaji); // L∆∞u l·∫°i Hiragana

            // 4. T·∫°o c√°c l·ª±a ch·ªçn nhi·ªÖu - ƒê√É CH·ªàNH S·ª¨A L·∫†I LOGIC ƒê·ªÇ C√ÅC S·ªê G·∫¶N NHAU H∆†N
            let choices = new Set([correctNumber]);
            const numChoices = 4;

            // Strategy 1: Add Close Distractors (differ by 1, 10, or 100)
            const closeDiffs = [1, -1, 10, -10, 100, -100];
            
            for (let diff of closeDiffs) {
                if (choices.size >= numChoices) break;
                
                const closeDistracter = correctNumber + diff;
                
                if (closeDistracter >= min && closeDistracter <= max && !choices.has(closeDistracter)) {
                    choices.add(closeDistracter);
                }
            }

            // Strategy 2: Fill remaining slots with random numbers (now allowing close proximity)
            while (choices.size < numChoices) {
                let randomDistracter = Math.floor(Math.random() * (max + 1 - min)) + min;
                if (!choices.has(randomDistracter)) {
                    choices.add(randomDistracter);
                }
            }

            choices = Array.from(choices).sort(() => Math.random() - 0.5);

            choices.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'choice-button p-3 rounded-xl font-bold transition-colors shadow-md';
                btn.textContent = num.toLocaleString('vi-VN'); 
                btn.dataset.value = num; 
                btn.onclick = () => checkAnswer(num, correctNumber, btn);
                gameChoicesEl.appendChild(btn);
            });
            
            // 5. Ph√°t √¢m l·∫ßn ƒë·∫ßu
            speakText(currentHiragana);
            startGameBtn.textContent = 'ƒêang Ph√°t √Çm...';
            startGameBtn.disabled = true;
        }

        // Replay Logic
        replayBtn.addEventListener('click', () => {
            if (ttsActive) return;

            if (gameState.replaysLeftInRound > 0) {
                gameState.replaysLeftInRound--;
                speakText(currentHiragana);
                updateReplayButtonState();
            } else {
                showToast("ƒê√£ h·∫øt l∆∞·ª£t nghe l·∫°i cho v√≤ng n√†y!", 'error');
            }
        });
        
        function checkAnswer(selectedNum, correctNum, buttonEl) {
            $$('.choice-button').forEach(btn => btn.disabled = true);
            
            if (selectedNum === correctNum) {
                buttonEl.classList.add('bg-green-500', 'text-white', 'shadow-lg');
                
                const scoreGain = 10 + gameState.comboStreak * 2;
                gameState.totalScore += scoreGain;
                gameState.comboStreak += 1;
                
                gameMessageEl.innerHTML = `‚úÖ Ch√≠nh x√°c! +${scoreGain} ƒëi·ªÉm. <span class="text-xs italic">(Combo: ${gameState.comboStreak})</span>`;
                showToast(`+${scoreGain} ƒêi·ªÉm! Combo x${gameState.comboStreak}!`, 'accent-color');

            } else {
                buttonEl.classList.add('bg-red-500', 'text-white', 'shadow-lg');
                $$('.choice-button').forEach(btn => {
                    if (parseInt(btn.dataset.value) === correctNum) {
                         btn.classList.add('bg-green-500', 'text-white', 'shadow-lg');
                    }
                });
                const romaji = convertToRomaji(correctNum);
                gameMessageEl.textContent = `‚ùå Sai r·ªìi. S·ªë ƒë√∫ng l√† ${correctNum.toLocaleString('vi-VN')} (${romaji}). Combo b·ªã ng·∫Øt.`;
                gameState.comboStreak = 0;
                
                showToast(`Sai r·ªìi. S·ªë ƒë√∫ng l√† ${correctNum.toLocaleString('vi-VN')}!`, 'error');
            }
            
            updateScoreDisplay(); // L∆∞u v√† hi·ªÉn th·ªã ƒëi·ªÉm m·ªõi
            
            // Thi·∫øt l·∫≠p v√≤ng m·ªõi sau 2 gi√¢y
            setTimeout(() => {
                startGameBtn.textContent = 'B·∫Øt ƒê·∫ßu V√≤ng M·ªõi';
                $$('.choice-button').forEach(btn => {
                    btn.classList.remove('bg-green-500', 'text-white', 'shadow-lg', 'bg-red-500');
                    btn.disabled = false;
                });
                generateGameRound();
            }, 2000);
        }
        
        // --- RANGE SELECTOR LOGIC ---
        rangeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const newMax = parseInt(e.target.dataset.range);
                
                gameState.maxNumber = newMax;
                gameState.minNumber = newMax < 1000 ? 0 : 100; // ƒê·∫∑t min l√† 100 n·∫øu > 1000 
                
                rangeDisplayEl.textContent = `Ph·∫°m vi hi·ªán t·∫°i: ${gameState.minNumber.toLocaleString('vi-VN')} - ${gameState.maxNumber.toLocaleString('vi-VN')}.`;

                rangeButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                generateGameRound();
                showToast(`ƒê√£ chuy·ªÉn ph·∫°m vi sang ${gameState.minNumber.toLocaleString('vi-VN')} - ${gameState.maxNumber.toLocaleString('vi-VN')}`, 'accent-color');
            });
        });

        // --- TOAST & UTILS ---
        function showToast(message, type = 'default') {
            toastEl.textContent = message;
            
            let color = getComputedStyle(document.documentElement).getPropertyValue('--main-color');
            if (type === 'accent-color') color = getComputedStyle(document.documentElement).getPropertyValue('--accent-color');
            if (type === 'error') color = '#EF4444'; // Red-500

            toastEl.style.backgroundColor = color;
            
            toastEl.classList.add('show');
            toastEl.style.opacity = '1';
            toastEl.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translateY(100px)';
                toastEl.classList.remove('show');
            }, 3000);
        }
        
        // Ch·ª©c nƒÉng copy (omitted for brevity, assume correct)
        // ...


        // --- NAVIGATION & TABS (gi·ªØ nguy√™n) ---
        const openMenuBtn = $('#openMenuBtn');
        const navMenu = $('#navMenu');
        const navOverlay = $('#navOverlay');

        openMenuBtn.addEventListener('click', () => {
            navMenu.classList.add('translate-x-0');
            navOverlay.classList.remove('hidden');
        });

        navOverlay.addEventListener('click', () => {
            navMenu.classList.remove('translate-x-0');
            navOverlay.classList.add('hidden');
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetPage = item.dataset.content;
                
                navItems.forEach(nav => nav.classList.remove('active', 'bg-red-50', 'dark:bg-gray-800', 'text-main-color'));
                item.classList.add('active', 'bg-red-50', 'dark:bg-gray-800', 'text-main-color');
                
                $$('.page-content').forEach(content => {
                    content.classList.add('hidden');
                    if (content.dataset.page === targetPage) {
                        content.classList.remove('hidden');
                    }
                });
                
                navMenu.classList.remove('translate-x-0');
                navOverlay.classList.add('hidden');
                
                if (targetPage === 'game') {
                    if (gameState.currentGameNumber === null) generateGameRound();
                }
                if (targetPage === 'score') {
                    updateScoreDisplay();
                }
            });
        });

        // --- DARK MODE (gi·ªØ nguy√™n) ---
        const themeToggle = $('#themeToggle');
        const themeIcon = $('#themeIcon');
        const themeText = $('#themeText');

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Ch·ªß ƒë·ªÅ S√°ng';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Ch·ªß ƒë·ªÅ T·ªëi';
            }
        }

        themeToggle.addEventListener('click', toggleTheme);

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Ch·ªß ƒë·ªÅ S√°ng';
            } else {
                document.body.classList.remove('dark');
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Ch·ªß ƒë·ªÅ T·ªëi';
            }
        }
        
        // --- INITIALIZATION ---
        window.onload = () => {
            applyInitialTheme();
            setupFirebase(); // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi Firebase
            startVoiceCheck();
            
            const today = new Date().toISOString().split('T')[0];
            $('#inputDate').value = today;
            
            // K√≠ch ho·∫°t n√∫t m·∫∑c ƒë·ªãnh 0-999
            const defaultRangeBtn = document.querySelector('[data-range="999"]');
            if (defaultRangeBtn) {
                 defaultRangeBtn.click(); 
            }
        };

        // Game Listener
        startGameBtn.addEventListener('click', () => {
            if (!ttsActive) {
                generateGameRound();
            } else {
                showToast("Vui l√≤ng ƒë·ª£i √¢m thanh ho√†n t·∫•t!", 'error');
            }
        });
    </script>
</body>
</html>
